
INSERT 	INTO 	{0}.{1} WITH cte_mbr_sdim AS( 	SELECT 		m3.mbr_frst_nm, 		m3.mbr_last_nm, 		m3.mbr_id, 		m3.mbr_gndr, 		m3.dt_of_brth, 		m3.mbr_age, 		m3.carr_id, 		m3.acct_id, 		m3.grp_id, 		m3.clnt_mbr_key, 		m3.mbr_key, 		m3.mbr_cvrg_efctv_dt, 		m3.mbr_cvrg_trmntn_dt, 		m3.curnt_age_year_nbr, 		m3.upid, 		m3.mbr_key_sdim, 		m3.line_1_adrs_txt, 		m3.line_2_adrs_txt, 		m3.phone_1_nbr 	FROM 		( 		SELECT 			m2.mbr_frst_nm, 			m2.mbr_last_nm, 			m2.mbr_id, 			m2.mbr_gndr, 			m2.dt_of_brth, 			m2.mbr_age, 			m2.carr_id, 			m2.acct_id, 			m2.grp_id, 			m2.clnt_mbr_key, 			m2.mbr_key, 			m2.mbr_cvrg_efctv_dt, 			m2.mbr_cvrg_trmntn_dt, 			m2.curnt_age_year_nbr, 			m2.upid, 			m2.mbr_key_sdim, 			m2.line_1_adrs_txt, 			m2.line_2_adrs_txt, 			m2.phone_1_nbr, 			DENSE_RANK() OVER(PARTITION BY m2.mbr_id, 			m2.mbr_cvrg_efctv_dt, 			m2.mbr_cvrg_trmntn_dt 		ORDER BY 			m2.mbr_cvrg_trmntn_dt DESC, 			m2.mbr_key_sdim DESC, 			m2.upid ASC) AS rnk		FROM 			( 			SELECT 				m1.mbr_frst_nm, 				m1.mbr_last_nm, 				m1.mbr_id, 				m1.mbr_gndr, 				m1.dt_of_brth, 				m1.mbr_age, 				m1.carr_id, 				m1.acct_id, 				m1.grp_id, 				m1.clnt_mbr_key, 				m1.mbr_key, 				m1.mbr_cvrg_efctv_dt, 				m1.mbr_cvrg_trmntn_dt, 				m1.curnt_age_year_nbr, 				CASE 					WHEN m1.clnt_type = 'integrated' THEN m1.clnt_upid 					ELSE m1.upid 				END AS upid, 				CASE 					WHEN m1.clnt_type = 'integrated' THEN m1.clnt_mbr_key 					ELSE m1.mbr_key 				END AS mbr_key_sdim, 				m1.line_1_adrs_txt, 				m1.line_2_adrs_txt, 				m1.phone_1_nbr 			FROM 				( 				SELECT 					frst_nm AS mbr_frst_nm, 					last_nm AS mbr_last_nm, 					mbr_id, 					CAST(clnt_upid AS VARCHAR) AS clnt_upid, 					src_mbr_gndr_cd AS mbr_gndr, 					brth_dt AS dt_of_brth, 					curnt_age_year_nbr AS mbr_age, 					carr_id, 					acct_id, 					grp_id, 					clnt_mbr_key, 					clnt_type, 					upid, 					mbr_key, 					mbr_cvrg_efctv_dt, 					mbr_cvrg_trmntn_dt, 					curnt_age_year_nbr, 					line_1_adrs_txt, 					line_2_adrs_txt, 					phone_1_nbr 				FROM 					{2}.mbr_snpsht_dim				where 					carr_id NOT IN ( 					SELECT 						phrmcy_carr_id					FROM 						{2}.bot_cust_carr_xwalk					WHERE 						phrmcy_carr_nm LIKE '%STCOB%'))m1 )m2 )m3 	where 		rnk = 1), 	cte_bt AS( 	SELECT 		clsfctn_obj_1_id, 		clsfctn_1_id 	FROM 		{2}.bot_gnrc_usebt	WHERE 		bt.tbl_type_id = 'IDWBOT009'), 	cte_dly_mstr AS( 	SELECT 		dly_mstr.pbm_clm_adjstmnt_key, 		dly_mstr.carr_id, 		dly_mstr.acct_id, 		dly_mstr.grp_id, 		dly_mstr.clnt_mbr_key, 		dly_mstr.ndc, 		dly_mstr.mbr_id AS mbr_id_clm, 		LAST_DAY(dly_mstr.adjdctn_dt) AS rpt_dt, 		dly_mstr.trnsctn_stts_cd, 		dly_mstr.cob_svngs_amt, 		dly_mstr.maint_drug_cd, 		CASE 			WHEN (dly_mstr.dspnsd_brnd_gnrc_cd IN ('Y', '') 			or dly_mstr.dspnsd_brnd_gnrc_cd is null) THEN 'G' 			ELSE 'B' 		END AS brnd_gnrc_cd, 		dly_mstr.dspnsd_brnd_gnrc_cd, 		dly_mstr.days_sply_nbr, 		dly_mstr.clnt_ingred_cost_paid_amt, 		dly_mstr.buy_ingred_cost_amt, 		dly_mstr.clnt_type, 		dly_mstr.rx_filld_dt, 		dly_mstr.adjdctn_dt, 		CASE 			WHEN dly_mstr.pbm_lob_cd = 'EXC' THEN 'COM' 			WHEN dly_mstr.pbm_lob_cd = 'MMP' THEN 'MCR' 			ELSE dly_mstr.pbm_lob_cd		END AS lob_cd, 		CASE 			WHEN dly_mstr.clnt_type = 'integrated' THEN dly_mstr.clnt_mbr_key			ELSE dly_mstr.mbr_key		END AS mbr_key_clm, 		dly_mstr.ntwk_id, 		dly_mstr.pbm_sor_desc, 		dly_mstr.pbm_lob_cd, 		dly_mstr.pbm_scrty_lvl_cd, 		dly_mstr.pbm_extrnl_load_cd, 		dly_mstr.guid, 		dly_mstr.trnsctn_cd, 		dly_mstr.pbm_sor_cd, 		dly_mstr.pbm_load_log_key, 		dly_mstr.prev_zone_pbm_load_log_key, 		dly_mstr.pbm_gbd_lob_cd, 		dly_mstr.pbm_gbd_st_cd, 		dly_mstr.ofshr_data_expsr_ind, 		dly_mstr.pbm_rcrd_hash_key, 		dly_mstr.clm_nbr, 		CASE 			WHEN rvsn_dim.pbm_clm_adjstmnt_key IS NOT NULL THEN 'Y' 			ELSE 'N' 		END AS paid_flag	FROM 		{2}.clm_phrmcy_dly_mstr_factdly_mstr	LEFT JOIN {2}.clm_phrmcy_dly_max_rvsn_dimrvsn_dim ON 		dly_mstr.pbm_clm_adjstmnt_key = rvsn_dim.pbm_clm_adjstmnt_key	WHERE 		trnsctn_stts_cd<> '2' 		AND adjdctn_dt BETWEEN CAST(DATE_TRUNC('month', '{3}'::DATE - INTERVAL '4 months') AS DATE) AND (LAST_DAY(ADD_MONTHS('{3}', 		-1))) 		AND cmpnd_cd<> '2' 		AND cob_svngs_amt = 0 		AND no_bill_no_rmt_ind_cd<> 'Y' 		AND bnft_cd NOT LIKE ('%PENCD%') 		AND (sbmsn_clrfctn_1_cd <> '20' 		OR sbmsn_clrfctn_2_cd <> '20' 		OR sbmsn_clrfctn_3_cd <> '20')), 	cte_claims AS( 	SELECT 		f_clm.rptg_mnth, 		f_clm.pbm_clm_adjstmnt_key, 		f_clm.mbr_key_clm, 		f_clm.clnt_mbr_key, 		f_clm.ndc, 		f_clm.rpt_dt, 		f_clm.trnsctn_stts_cd, 		f_clm.clm_nbr, 		f_clm.cob_svngs_amt, 		f_clm.maint_drug_cd, 		f_clm.bt_maint_drug_cd, 		f_clm.brnd_gnrc_cd, 		f_clm.days_sply_nbr, 		f_clm.clnt_ingred_cost_paid_amt, 		f_clm.buy_ingred_cost_amt, 		f_clm.ntwk_id, 		f_clm.dspnsd_brnd_gnrc_cd, 		f_clm.brnd_nm, 		listagg(DISTINCT 		(CASE 			WHEN f_clm.rtl_mail_cd = 'R' 			AND f_clm.maint_drug_cd = 'X' 			AND f_clm.paid_flag = 'Y' THEN f_clm.brnd_nm		END), 		',') WITHIN GROUP ( 	ORDER BY 		f_clm.mbr_id, 		f_clm.upid, 		f_clm.lob_cd) OVER (PARTITION BY f_clm.mbr_id, 		f_clm.upid, 		f_clm.lob_cd) AS mbr_rtl_maint_drug_brnd_nm_lst, 		listagg(DISTINCT 		(CASE 			WHEN f_clm.rtl_mail_cd = 'M' 			AND f_clm.paid_flag = 'Y' THEN f_clm.brnd_nm		END), 		',') WITHIN GROUP ( 	ORDER BY 		f_clm.mbr_id, 		f_clm.upid, 		f_clm.lob_cd) OVER (PARTITION BY f_clm.mbr_id, 		f_clm.upid, 		f_clm.lob_cd) AS mbr_mail_drug_brnd_nm_list, 		f_clm.gpi_2_grp_desc, 		f_clm.sum_days, 		CASE 			WHEN f_clm.paid_flag = 'Y' 			AND f_clm.sum_days<> 0 			AND ((f_clm.rtl_mail_cd = 'R' 			and f_clm.maint_drug_cd = 'X') 			OR f_clm.rtl_mail_cd = 'M') THEN DENSE_RANK() OVER(PARTITION BY f_clm.mbr_id, 			f_clm.upid, 			f_clm.lob_cd		ORDER BY 			f_clm.mbr_id, 			f_clm.upid, 			f_clm.lob_cd, 			f_clm.sum_days DESC) 			ELSE 0 		END AS gpi_desc_rnk, 		f_clm.rtl_mail_cd, 		f_clm.clnt_type, 		f_clm.lob_cd, 		f_clm.dt_of_brth, 		f_clm.mbr_age, 		f_clm.rx_filld_dt, 		f_clm.adjdctn_dt, 		f_clm.mnth_rnk, 		f_clm.paid_flag, 		f_clm.curnt_age_year_nbr, 		f_clm.mbr_id, 		f_clm.upid, 		f_clm.mbr_frst_nm, 		f_clm.mbr_last_nm, 		f_clm.mbr_gndr, 		f_clm.mbr_cvrg_efctv_dt, 		f_clm.mbr_cvrg_trmntn_dt, 		f_clm.pbm_sor_desc, 		f_clm.pbm_lob_cd, 		f_clm.pbm_scrty_lvl_cd, 		f_clm.pbm_extrnl_load_cd, 		f_clm.guid, 		f_clm.trnsctn_cd, 		f_clm.pbm_sor_cd, 		f_clm.pbm_load_log_key, 		f_clm.prev_zone_pbm_load_log_key, 		f_clm.pbm_gbd_lob_cd, 		f_clm.pbm_gbd_st_cd, 		f_clm.ofshr_data_expsr_ind, 		f_clm.pbm_rcrd_hash_key, 		CASE 			WHEN f_clm.line_1_adrs_txt IS NULL THEN f_clm.line_2_adrs_txt 			WHEN f_clm.line_2_adrs_txt IS NULL THEN f_clm.line_1_adrs_txt 			ELSE (f_clm.line_1_adrs_txt || ',' || f_clm.line_2_adrs_txt) 		END AS mbr_prmry_adrs, 		f_clm.phone_1_nbr AS mbr_phone_nbr_1 	FROM 		( 		SELECT 			CAST(TO_CHAR(DATEADD(MONTH,-0, '{3}'), 'YYYYMM') AS INT) AS rptg_mnth, 			clm.pbm_clm_adjstmnt_key, 			clm.carr_id, 			clm.acct_id, 			clm.grp_id, 			clm.mbr_key_clm, 			clm.clnt_mbr_key, 			clm.ndc, 			clm.mbr_id_clm, 			clm.rpt_dt, 			clm.trnsctn_stts_cd, 			clm.cob_svngs_amt, 			clm.maint_drug_cd, 			bdg.maint_drug_cd AS bt_maint_drug_cd, 			clm.brnd_gnrc_cd, 			clm.days_sply_nbr, 			clm.clnt_ingred_cost_paid_amt, 			clm.buy_ingred_cost_amt, 			clm.ntwk_id, 			clm.dspnsd_brnd_gnrc_cd, 			bdg.brnd_nm, 			bdg.gpi_2_grp_desc, 			SUM(CASE WHEN clm.paid_flag = 'Y' AND ((COALESCE(bt.clsfctn_obj_1_id, 'R') = 'R' AND clm.maint_drug_cd = 'X') OR bt.clsfctn_obj_1_id = 'M') THEN clm.days_sply_nbr ELSE 0 END) OVER (PARTITION BY sdim.mbr_id, 			sdim.upid, 			clm.lob_cd, 			clm.paid_flag, 			bdg.gpi_2_grp_desc) AS sum_days, 			CASE 				WHEN bt.clsfctn_obj_1_id = 'S' THEN 'S' 				WHEN bt.clsfctn_obj_1_id = 'M' THEN 'M' 				ELSE 'R' 			END AS rtl_mail_cd, 			clm.clm_nbr, 			clm.clnt_type, 			clm.paid_flag, 			clm.rx_filld_dt, 			clm.adjdctn_dt, 			clm.lob_cd, 			clm.pbm_sor_desc, 			clm.pbm_lob_cd, 			clm.pbm_scrty_lvl_cd, 			clm.pbm_extrnl_load_cd, 			clm.guid, 			clm.trnsctn_cd, 			clm.pbm_sor_cd, 			clm.pbm_load_log_key, 			clm.prev_zone_pbm_load_log_key, 			clm.pbm_gbd_lob_cd, 			clm.pbm_gbd_st_cd, 			clm.ofshr_data_expsr_ind, 			clm.pbm_rcrd_hash_key, 			(EXTRACT(MONTH 		FROM 			(date_trunc('month', '{3}'::date) + interval 'month - 1 day')::date ) - EXTRACT (MONTH 		FROM 			LAST_DAY(clm.adjdctn_dt))) as mnth_rnk, 			sdim.curnt_age_year_nbr, 			sdim.mbr_frst_nm AS mbr_frst_nm_1, 			first_value(sdim.mbr_frst_nm) OVER (PARTITION BY sdim.mbr_id, 			sdim.upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS mbr_frst_nm, 			sdim.mbr_last_nm AS mbr_last_nm_1, 			first_value(sdim.mbr_last_nm) OVER (PARTITION BY sdim.mbr_id, 			sdim.upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS mbr_last_nm, 			sdim.mbr_id, 			sdim.upid, 			sdim.mbr_gndr AS mbr_gndr_1, 			first_value(sdim.mbr_gndr) OVER (PARTITION BY sdim.mbr_id, 			sdim.upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS mbr_gndr, 			sdim.dt_of_brth AS dt_of_brth_1, 			first_value(sdim.dt_of_brth) OVER (PARTITION BY sdim.mbr_id, 			upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS dt_of_brth, 			sdim.mbr_age AS mbr_age_1, 			first_value(sdim.mbr_age) OVER (PARTITION BY sdim.mbr_id, 			upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS mbr_age, 			first_value(sdim.line_1_adrs_txt) OVER (PARTITION BY sdim.mbr_id, 			upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS line_1_adrs_txt, 			first_value(sdim.line_2_adrs_txt) OVER (PARTITION BY sdim.mbr_id, 			upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS line_2_adrs_txt, 			first_value(sdim.phone_1_nbr) OVER (PARTITION BY sdim.mbr_id, 			upid		ORDER BY 			sdim.mbr_cvrg_trmntn_dt DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS phone_1_nbr, 			sdim.mbr_cvrg_efctv_dt, 			sdim.mbr_cvrg_trmntn_dt		FROM 			cte_dly_mstrclm		INNER JOIN cte_mbr_sdimsdim ON 			clm.mbr_key_clm = sdim.mbr_key_sdim			AND clm.adjdctn_dt BETWEEN sdim.mbr_cvrg_efctv_dt AND sdim.mbr_cvrg_trmntn_dt		LEFT JOIN {2}.bot_drugbdg ON 			bdg.ndc = clm.ndc		LEFT JOIN cte_btbt ON 			clm.ntwk_id = bt.clsfctn_1_id)f_clm) SELECT 	c2.rptg_mnth, 	c2.mbr_id, 	c2.lob_cd, 	c2.upid, 	c2.mbr_gndr, 	c2.dt_of_brth, 	c2.mbr_age, 	c2.mbr_frst_nm, 	c2.mbr_last_nm, 	c2.mbr_prmry_adrs, 	c2.mbr_phone_nbr_1, 	c2.mbr_phone_nbr_2, 	c2.mbr_email_id, 	c2.mbr_r30_maint_clms_cnt, 	c2.mbr_r30_acut_clms_cnt, 	c2.mbr_r90_clms_cnt, 	c2.mbr_mail_clms_cnt, 	c2.mbr_spclty_chnl_clms_cnt, 	c2.mbr_totl_clms_cnt, 	c2.mbr_r30_maint_days_sply, 	c2.mbr_r30_acut_days_sply, 	c2.mbr_r90_days_sply, 	c2.mbr_mail_days_sply, 	c2.mbr_spclty_chnl_days_sply, 	c2.mbr_totl_days_sply, 	c2.totl_brnd_maint_drug_clms_cnt, 	c2.totl_gnrc_maint_drug_clms_cnt, 	c2.totl_brnd_maint_drug_days_sply_cnt, 	c2.totl_gnrc_maint_drug_days_sply_cnt, 	c2.mbr_r30_maint_clnt_ingred_cost, 	c2.mbr_r30_acut_clnt_ingred_cost, 	c2.mbr_r90_clnt_ingred_cost, 	c2.mbr_mail_clnt_ingred_cost, 	c2.mbr_spclty_chnl_clnt_ingred_cost, 	c2.mbr_totl_clnt_ingred_cost, 	c2.mbr_r30_maint_buy_ingred_cost, 	c2.mbr_r30_acut_buy_ingred_cost, 	c2.mbr_r90_buy_ingred_cost, 	c2.mbr_mail_buy_ingred_cost, 	c2.mbr_spclty_chnl_buy_ingred_cost, 	c2.mbr_totl_buy_ingred_cost, 	c2.upcomng_maint_r30_refils_clms_cnt, 	c2.upcomng_r90_refils_in_30d_clms_cnt, 	c2.upcomng_r90_refils_in_60d_clms_cnt, 	c2.upcomng_r90_refils_in_90d_clms_cnt, 	c2.upcomng_mail_refils_in_30d_clms_cnt, 	c2.upcomng_mail_refils_in_60d_clms_cnt, 	c2.upcomng_mail_refils_in_90d_clms_cnt, 	c2.mbr_maint_mail_utlz_type, 	c2.mbr_rtl_maint_drug_brnd_nm_lst, 	c2.mbr_mail_drug_brnd_nm_list, 	c2.mbr_maint_top_1_gpi2_desc, 	c2.mbr_maint_top_2_gpi2_desc, 	c2.mbr_maint_top_3_gpi2_desc, 	c2.mbr_maint_utlz_ind, 	c2.pbm_sor_desc, 	c2.pbm_lob_cd, 	c2.pbm_scrty_lvl_cd, 	c2.pbm_extrnl_load_cd, 	c2.guid, 	md5(c2.rptg_mnth || ',' || c2.mbr_id || ',' || c2.upid || ',' || c2.lob_cd ) AS pk_hash_key, 	c2.trnsctn_cd, 	c2.pbm_sor_cd, 	c2.pbm_load_log_key, 	c2.load_dtm, 	c2.prev_zone_pbm_load_log_key, 	c2.pbm_gbd_lob_cd, 	c2.pbm_gbd_st_cd, 	c2.ofshr_data_expsr_ind, 	c2.pbm_rcrd_hash_key, 	c2.load_ingstn_id FROM 	( 	SELECT 		c1.rptg_mnth, 		COALESCE(c1.mbr_id, 'UNK') AS mbr_id, 		COALESCE(c1.lob_cd, 'UNK') AS lob_cd, 		COALESCE(c1.upid, 'UNK') AS upid, 		c1.mbr_gndr, 		c1.dt_of_brth, 		c1.mbr_age, 		c1.mbr_frst_nm, 		c1.mbr_last_nm, 		c1.mbr_prmry_adrs, 		c1.mbr_phone_nbr_1, 		'NA' AS mbr_phone_nbr_2, 		'NA' AS mbr_email_id, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.days_sply_nbr < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND ABS(c1.days_sply_nbr) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_r30_maint_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd <> 'X' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.days_sply_nbr < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd <> 'X' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND ABS(c1.days_sply_nbr) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_r30_acut_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.days_sply_nbr >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND ABS(c1.days_sply_nbr) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_r90_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_mail_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'S' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.rtl_mail_cd = 'S' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_spclty_chnl_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '3' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS mbr_totl_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_r30_maint_days_sply, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd <> 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_r30_acut_days_sply, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_r90_days_sply, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_mail_days_sply, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'S' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_spclty_chnl_days_sply, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS mbr_totl_days_sply, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'B' AND c1.trnsctn_stts_cd = '1' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'B' AND c1.trnsctn_stts_cd = '3' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS totl_brnd_maint_drug_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'G' AND c1.trnsctn_stts_cd = '1' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'G' AND c1.trnsctn_stts_cd = '3' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN -1 ELSE 0 END END), 		0) AS totl_gnrc_maint_drug_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'B' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS totl_brnd_maint_drug_days_sply_cnt, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.brnd_gnrc_cd = 'G' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.days_sply_nbr ELSE 0 END), 		0) AS totl_gnrc_maint_drug_days_sply_cnt, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_r30_maint_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd <> 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_r30_acut_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_r90_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_mail_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'S' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_spclty_chnl_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.clnt_ingred_cost_paid_amt ELSE 0 END), 		0) AS mbr_totl_clnt_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_r30_maint_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd <> 'X' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_r30_acut_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND (CASE WHEN c1.trnsctn_stts_cd = '3' THEN ABS(c1.days_sply_nbr) ELSE c1.days_sply_nbr END) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_r90_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_mail_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.rtl_mail_cd = 'S' AND c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_spclty_chnl_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.mnth_rnk = 0 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.buy_ingred_cost_amt ELSE 0 END), 		0) AS mbr_totl_buy_ingred_cost, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND ABS(c1.days_sply_nbr) < 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_maint_r30_refils_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 2 AND c1.trnsctn_stts_cd = '1' AND ABS(c1.days_sply_nbr) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_r90_refils_in_30d_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 1 AND c1.trnsctn_stts_cd = '1' AND ABS(c1.days_sply_nbr) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_r90_refils_in_60d_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'R' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND ABS(c1.days_sply_nbr) >= 84 AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_r90_refils_in_90d_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 2 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_mail_refils_in_30d_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 1 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_mail_refils_in_60d_clms_cnt, 		COALESCE (SUM(CASE WHEN c1.paid_flag = 'Y' AND c1.rtl_mail_cd = 'M' AND c1.mnth_rnk = 0 AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 		0) AS upcomng_mail_refils_in_90d_clms_cnt, 		COALESCE ( 		(CASE 			WHEN MAX(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND c1.rtl_mail_cd <> 'S' AND c1.maint_drug_cd = 'X' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) = 'R' 			AND MIN(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) = 'M' THEN 'Retail & Mail' 			ELSE 			CASE 				WHEN MAX(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND c1.rtl_mail_cd <> 'R' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) IN ('M', 'S') 				AND MIN(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) = 'M' THEN 'Mail Only' 				ELSE 				CASE 					WHEN MAX(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'S') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) IN ('R', 'S') 					AND MIN(CASE WHEN c1.mnth_rnk IN (0, 1, 2, 3) AND c1.paid_flag = 'Y' AND c1.trnsctn_stts_cd = '1' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'S') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN c1.rtl_mail_cd END) = 'R' THEN 'Retail Only' 				END 			END		END ), 		'') AS mbr_maint_mail_utlz_type, 		MAX(CAST(c1.mbr_rtl_maint_drug_brnd_nm_lst AS VARCHAR(255))) AS mbr_rtl_maint_drug_brnd_nm_lst, 		MAX(CAST(c1.mbr_mail_drug_brnd_nm_list AS VARCHAR(255))) AS mbr_mail_drug_brnd_nm_list, 		MAX(CASE WHEN c1.gpi_desc_rnk = 1 THEN c1.gpi_2_grp_desc ELSE '' END) AS mbr_maint_top_1_gpi2_desc, 		MAX(CASE WHEN c1.gpi_desc_rnk = 2 THEN c1.gpi_2_grp_desc ELSE '' END) AS mbr_maint_top_2_gpi2_desc, 		MAX(CASE WHEN c1.gpi_desc_rnk = 3 THEN c1.gpi_2_grp_desc ELSE '' END) AS mbr_maint_top_3_gpi2_desc, 		COALESCE(MAX(CASE WHEN c1.paid_flag = 'Y' AND ((c1.rtl_mail_cd = 'R' AND c1.maint_drug_cd = 'X') OR c1.rtl_mail_cd = 'M') AND c1.pbm_clm_adjstmnt_key IS NOT NULL THEN 1 ELSE 0 END), 0) AS mbr_maint_utlz_ind, 		MAX(c1.pbm_sor_desc) AS pbm_sor_desc, 		MAX(c1.pbm_lob_cd) AS pbm_lob_cd, 		MAX(c1.pbm_scrty_lvl_cd) AS pbm_scrty_lvl_cd, 		MAX(c1.pbm_extrnl_load_cd) AS pbm_extrnl_load_cd, 		MAX(c1.guid) AS guid, 		MAX(c1.trnsctn_cd) AS trnsctn_cd, 		MAX(c1.pbm_sor_cd) AS pbm_sor_cd, 		MAX(c1.pbm_load_log_key) AS pbm_load_log_key, 		CURRENT_TIMESTAMP AS load_dtm, 		MAX(c1.prev_zone_pbm_load_log_key) AS prev_zone_pbm_load_log_key, 		MAX(c1.pbm_gbd_lob_cd) AS pbm_gbd_lob_cd, 		MAX(c1.pbm_gbd_st_cd) AS pbm_gbd_st_cd, 		MAX(c1.ofshr_data_expsr_ind) AS ofshr_data_expsr_ind, 		MAX(c1.pbm_rcrd_hash_key) AS pbm_rcrd_hash_key, 		TO_CHAR(GETDATE(), 'YYYYMMDD') AS load_ingstn_id	FROM 		cte_claims c1 	GROUP BY 		c1.mbr_id, 		c1.lob_cd, 		c1.upid, 		c1.mbr_gndr, 		c1.dt_of_brth, 		c1.mbr_age, 		c1.mbr_frst_nm, 		c1.mbr_last_nm, 		c1.rptg_mnth, 		c1.mbr_prmry_adrs, 		c1.mbr_phone_nbr_1)c2 where 	c2.mbr_totl_clms_cnt <> 0 	OR c2.mbr_totl_days_sply <> 0 	OR c2.totl_brnd_maint_drug_clms_cnt <> 0 	OR c2.totl_gnrc_maint_drug_clms_cnt <> 0 	OR c2.totl_brnd_maint_drug_days_sply_cnt <> 0 	OR c2.totl_gnrc_maint_drug_days_sply_cnt <> 0 	OR c2.mbr_totl_clnt_ingred_cost <> 0 	OR c2.mbr_totl_buy_ingred_cost <> 0 	OR c2.upcomng_maint_r30_refils_clms_cnt <> 0 	OR c2.upcomng_r90_refils_in_30d_clms_cnt <> 0 	OR c2.upcomng_r90_refils_in_60d_clms_cnt <> 0 	OR c2.upcomng_r90_refils_in_90d_clms_cnt <> 0 	OR c2.upcomng_mail_refils_in_30d_clms_cnt <> 0 	OR c2.upcomng_mail_refils_in_60d_clms_cnt <> 0 	OR c2.upcomng_mail_refils_in_90d_clms_cnt <> 0 	OR c2.mbr_maint_mail_utlz_type <> '' 	OR c2.mbr_maint_utlz_ind <> 0 	OR c2.mbr_rtl_maint_drug_brnd_nm_lst <> '' 	OR c2.mbr_mail_drug_brnd_nm_list <> '' 	OR c2.mbr_maint_top_1_gpi2_desc <> '' 	OR c2.mbr_maint_top_2_gpi2_desc <> '' 	OR c2.mbr_maint_top_3_gpi2_desc <> '';
